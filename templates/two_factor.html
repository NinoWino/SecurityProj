{% extends "base.html" %}
{% block content %}
<div class="container d-flex flex-column align-items-center justify-content-center mt-5">
  <div class="col-md-4">
    <h3 class="text-center mb-3">Verification Code</h3>
    <p class="text-center text-muted">Enter the 6-digit code sent to your email.</p>
    <form method="POST" id="otpForm">
      {{ form.hidden_tag() }}
      <input type="hidden" id="token-field" name="{{ form.token.name }}">
      <div class="d-flex justify-content-center gap-2 my-4 verification-input-container">
        <input type="text" name="digit1" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input" autofocus>
        <input type="text" name="digit2" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input">
        <input type="text" name="digit3" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input">
        <input type="text" name="digit4" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input">
        <input type="text" name="digit5" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input">
        <input type="text" name="digit6" maxlength="1" pattern="\d*" inputmode="numeric" class="form-control text-center verification-input">
      </div>
      <button type="submit" class="btn btn-dark w-100">Verify Account</button>
      {% if resent %}
      <div class="alert alert-success mt-3 text-center">
        A new code has been sent.
      </div>
      {% endif %}

      {% if error %}
        <div class="alert alert-danger mt-3 text-center">{{ error }}</div>
      {% endif %}
    </form>
    <div class="text-center mt-3">
      Didnâ€™t receive code? <a href="{{ url_for('resend_otp', context='login') }}">Resend</a>
    </div>
    <div class="text-center mt-3">
      <button type="button" class="btn btn-link text-muted" data-bs-toggle="modal" data-bs-target="#backupCodeModal">
        Use Backup Code Instead
      </button>
    </div>

  </div>
</div>
<div class="modal fade" id="backupCodeModal" tabindex="-1" aria-labelledby="backupCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('two_factor') }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="backupCodeModalLabel">Enter Backup Code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Enter one of your one-time backup codes to bypass 2FA.</p>
          {% if backup_code_error %}
            <div class="alert alert-danger">{{ backup_code_error }}</div>
          {% endif %}
          <input type="text" name="backup_code" class="form-control" placeholder="Backup Code" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Submit Code</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% if backup_code_error %}
<script>
  var modal = new bootstrap.Modal(document.getElementById('backupCodeModal'));
  modal.show();
</script>
{% endif %}

<style>
.verification-input {
  width: 3rem;
  height: 3rem;
  font-size: 1.5rem;
}
.verification-input-container input::selection {
  background: #0d6efd;
  color: #fff;
}
</style>
<script>
(function() {
  const inputs = document.querySelectorAll('.verification-input');
  const container = document.querySelector('.verification-input-container');

  inputs.forEach((input, idx) => {
    // Block non-numeric input
    input.addEventListener('keypress', (e) => {
      if (!/[0-9]/.test(e.key)) {
        e.preventDefault();
      }
    });

    // Auto-forward and strip invalid characters
    input.addEventListener('input', () => {
      input.value = input.value.replace(/\D/g, '');  // remove non-digits
      if (input.value.length === 1 && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }
    });

    // Handle keyboard nav
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && idx > 0) {
        inputs[idx - 1].focus();
      } else if (e.key === 'ArrowLeft' && idx > 0) {
        inputs[idx - 1].focus();
        e.preventDefault();
      } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
        e.preventDefault();
      }
    });

    // Paste handling
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text')
        .replace(/\D/g, '')
        .slice(0, inputs.length);
      paste.split('').forEach((d, i) => {
        inputs[i].value = d;
      });
      const firstEmpty = Array.from(inputs).find(inp => !inp.value);
      (firstEmpty || inputs[inputs.length - 1]).focus();
    });
  });

  container.addEventListener('click', () => {
    const firstEmpty = Array.from(inputs).find(inp => !inp.value);
    (firstEmpty || inputs[0]).focus();
  });

  // Combine input values into hidden field
  document.getElementById('otpForm').addEventListener('submit', function(e) {
    const token = Array.from(inputs).map(inp => inp.value).join('');
    document.getElementById('token-field').value = token;
  });
})();
</script>

{% if wait_seconds %}
  <div class="text-center text-muted mt-3">
    You can request another OTP in <span id="countdown">{{ wait_seconds }}</span> seconds.
  </div>
  <script>
    let remaining = {{ wait_seconds }};
    const el = document.getElementById('countdown');
    const interval = setInterval(() => {
      remaining -= 1;
      el.textContent = remaining;
      if (remaining <= 0) clearInterval(interval);
    }, 1000);
  </script>
{% endif %}


{% endblock %}
