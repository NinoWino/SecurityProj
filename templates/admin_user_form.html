{% extends "base.html" %}
{% block content %}
<style>
  .dashboard-container {
    max-width: 1100px;
    margin: 2rem auto;
  }
</style>

<div class="dashboard-container">
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">{{ action }} User</h2>
      <a href="{{ url_for('manage_users') }}" class="btn btn-sm btn-outline-light">â† Back to Users</a>
    </div>

    <div class="card-body">
      <form method="post" class="mb-2">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

        <div class="row g-3">
          <div class="col-md-6">
            <label for="username" class="form-label">Username</label>
            <input id="username"
                   name="username"
                   class="form-control"
                   value="{{ user.username if user else '' }}"
                   required>
          </div>

          <div class="col-md-6">
            <label for="email" class="form-label">Email</label>
            <input id="email"
                   type="email"
                   name="email"
                   class="form-control"
                   value="{{ user.email if user else '' }}"
                   required>
          </div>

          <div class="col-md-6">
            <label for="password" class="form-label">
              Password {% if action == 'Edit' %}<small class="text-muted">(leave blank to keep current)</small>{% endif %}
            </label>
            <input id="password"
                   type="password"
                   name="password"
                   class="form-control"
                   {% if action != 'Edit' %}required{% endif %}>
          </div>

          <div class="col-md-6">
            <label for="role_id" class="form-label">Role</label>
            <select id="role_id" name="role_id" class="form-select" required>
              <option value="1" {% if user and user.role_id == 1 %}selected{% endif %}>User</option>
              <option value="2" {% if user and user.role_id == 2 %}selected{% endif %}>Staff</option>
              <option value="3" {% if user and user.role_id == 3 %}selected{% endif %}>Admin</option>

              {# Show Master Admin only if current user is Master Admin #}
              {% if current_user.is_authenticated and current_user.is_master_admin %}
                <option value="4" {% if user and user.role_id == 4 %}selected{% endif %}>Master Admin</option>
              {% endif %}
            </select>

            {% if current_user.is_authenticated and current_user.is_master_admin %}
              <small class="text-primary d-block mt-1">
                ğŸ‘‘ You can assign Master Admin. Use with care.
              </small>
            {% else %}
              <small class="text-muted d-block mt-1">
                Only a Master Admin can assign the Master Admin role.
              </small>
            {% endif %}
          </div>

          <!-- Status toggle (kept) -->
          <div class="col-md-6">
            <label class="form-label d-block">Status</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                     {% if not user or user.is_active %}checked{% endif %}>
              <label class="form-check-label" for="is_active">Active</label>
            </div>
            <small class="text-muted">Uncheck to create/deactivate this user.</small>
          </div>

          {# 2FA section removed as requested #}
        </div>

        <hr class="my-4">

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success">{{ action }}</button>
          <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>

      {% if user %}
      <!-- Read-only summary -->
      <div class="card mt-4">
        <div class="card-header bg-light">
          <strong>Current User Summary</strong>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <small class="text-muted d-block">User ID</small>
              <div class="fw-semibold">{{ user.id }}</div>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Role</small>
              <div>
                {% if user.role_id == 4 %}
                  <span class="badge bg-primary"><i class="bi bi-shield-lock-fill"></i> Master Admin</span>
                {% elif user.role_id == 3 %}
                  <span class="badge bg-warning text-dark">Admin</span>
                {% elif user.role_id == 2 %}
                  <span class="badge bg-info text-dark">Staff</span>
                {% elif user.role_id == 1 %}
                  <span class="badge bg-secondary">User</span>
                {% else %}
                  <span class="badge bg-light text-dark">Unknown</span>
                {% endif %}
              </div>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Status</small>
              <div>
                <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                  {% if user.is_active %}Active{% else %}Deactivated{% endif %}
                </span>
              </div>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Created</small>
              <div>{{ (user.created_at|string) if user.created_at else '-' }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
